<!DOCTYPE html>
<html>
	<head>
		<title>French Toast Course Reports</title>
		<link rel='stylesheet' href='lib/nv.d3.css'/>
		<script type="text/javascript" src="lib/d3.v3.js" charset="utf-8"></script>
		<script type="text/javascript" src="lib/nv.d3.js"></script>
		<script type="text/javascript" src="lib/xapiwrapper.min.js"></script>
		<script type="text/javascript" src="src/chart.js"></script>
		<script type="text/javascript" src="src/dashboard.js"></script>
		<script type="text/javascript" src="src/xapicollection.js"></script>

		<style>
			h2 {
				text-align: center;
			}
			#graphContainer {
				display: flex;
				flex-direction: row;
				justify-content: center;
				align-items: center;
				flex-wrap: wrap;
			}

			.container {
				width: 5000px;
				height: 300px;
				overflow: hidden;
			}
		</style>

	</head>
	<body>
        <h1>How to Make French Toast Course - Reports from the LRS</h1>
        <a href="../index.html">&lt; back</a></br ><br />
		<span id='status'>Fetching data</span>
		<div id='graphContainer'>
			<div id='verbs' class='container'>
				<svg></svg>
			</div>
			<div id='subChart1' class='container'>
				<h3 style="text-align:center;"></h3>
				<svg></svg>
			</div>
			<div id='lrsActivity' class='container'>
				<svg></svg>
			</div>
			<div id='actorActivity' class='container'>
				<svg></svg>
			</div>
			<div id='subChart2' class='container'>
				<h3 style="text-align:center;"></h3>
				<svg></svg>
			</div>
		</div>
        <p><a href="http://adlnet.github.io/xapi-jqm/demos/course/index.html">Take the Course on How to Make French Toast!</a></p>
        <p>Reports made possible by <a href="https://github.com/adlnet/xAPI-Dashboard" target="_blank">xAPI-Dashboard</a></p>
		<script>

			var wrapper = ADL.XAPIWrapper;
			var dash = new ADL.XAPIDashboard();
			wrapper.changeConfig({'endpoint': 'https://lrs.adlnet.gov/xAPI/'});

			var handle = setInterval(function(){
				document.querySelector('span').innerHTML += '.';
			}, 500);

			var cutoff = new Date(Date.now());
			cutoff = new Date(cutoff.getFullYear(),cutoff.getMonth(),cutoff.getDate()-30);
			cutoff = cutoff.toISOString();

			var globalVerb;

			//dash.fetchAllStatements({since: cutoff, "agent": JSON.stringify({"objectType":"Agent","mbox":"mailto:tyler.mulligan.ctr@adlnet.gov"}), related_agents: true }, wrapper, function()
			dash.fetchAllStatements({since: cutoff, activity: "http://adlnet.gov/xapi/samples/xapi-jqm/course/", related_activities: true }, wrapper, function()
			{
				var globalMbox;

				clearInterval(handle);

				// label for first graph
				var container = document.querySelector('#verbs');
				var header = document.createElement('h2');
				header.innerHTML = 'Verb Popularity Over Last 30 Days';
				container.insertBefore(header, container.firstChild);
	
				// create first graph
				var verbsChart = dash.createBarChart({
					container: '#verbs svg',
					groupBy: 'verb.id',
					aggregate: ADL.count(),
					child: objChart,
					post: function(data){
						data = new ADL.CollectionSync(data);
						return data.orderBy('out','descending').slice(0,10).contents;
					},
					customize: function(nvd3chart){
						nvd3chart.margin({bottom: 150, right: 50});
						nvd3chart.xAxis.rotateLabels(45);
						nvd3chart.xAxis.tickFormat(function(label){
							//var parts = /https?:\/\/.*?(\w+\.\w{2,3}).*(\/.+)$/.exec(label);
							//return parts.slice(1,3).join('');
							return /[^\/]+$/.exec(label)[0];
						});
					}
				});

				var objChart = dash.createBarChart({
			        container: "#subChart1 svg",
			        groupBy: 'object.id',
			        aggregate: ADL.count(),
			        pre: function(data, event){
			        	globalVerb = event.in;
						data.where('verb.id =  /'+event.in+'$/'); 
					},
			        customize: function (chart) {
			        	var verb = /[^\/]+$/.exec(globalVerb)[0];
			        	ADL.$('#subChart1 h3').textContent = verb.charAt(0).toUpperCase() + verb.slice(1) + " Objects";
			            chart.xAxis.rotateLabels(45);
			            chart.xAxis.tickFormat(function(label){
			                return /[^\/]+$/.exec(label)});			            
			        }
			    });

				
				// draw first graph once it's configured
				verbsChart.addChild(objChart);
				verbsChart.draw();


				// label for second graph
				container = document.querySelector('#lrsActivity');
				header = document.createElement('h2');
				header.innerHTML = 'LRS Activity Over Last 30 Days';
				container.insertBefore(header, container.firstChild);
	
				// create second graph
				var activityChart = dash.createLineChart({
					container: '#lrsActivity svg',
					groupBy: 'stored',
					range: {
						start: cutoff,
						end: (new Date(Date.now())).toISOString(),
						increment: 1000*3600*24
					},
					rangeLabel: 'start',
					aggregate: ADL.count(),
					post: function(data){
						for(var i=0; i<data.length; i++){
							data[i].in = Date.parse(data[i].in);
						}
						return data;
					},
					customize: function(nvd3chart){
						nvd3chart.xAxis.tickFormat(function(label){
							return d3.time.format('%b %d')(new Date(label));
						});
					}
				});
				activityChart.draw();


				// label for third graph
				container = document.querySelector('#actorActivity');
				header = document.createElement('h2');
				header.innerHTML = 'Most Active Actors Over Last 30 Days';
				container.insertBefore(header, container.firstChild);
	
				var actorChart = dash.createBarChart({
					container: '#actorActivity svg',
					groupBy: 'actor.mbox',
					aggregate: ADL.count(),
					child: objChart,
					post: function(data){
						data = new ADL.CollectionSync(data);
						return data.orderBy('out', 'descending').slice(0,10).contents;
					},
					customize: function(nvd3chart){
						nvd3chart.xAxis.rotateLabels(45);
						nvd3chart.xAxis.tickFormat(function(label){
							return label.slice(7);
						});
						nvd3chart.margin({right: 80, bottom: 150});
					}
				});

				var objChart = dash.createBarChart({
			        container: "#subChart2 svg",
			        groupBy: 'stored',
					range: {
						start: cutoff,
						end: (new Date(Date.now())).toISOString(),
						increment: 1000*3600*24
					},
					rangeLabel: 'start',
			        aggregate: ADL.count(),
			        pre: function(data, event){
			        	globalMbox = event.in;
						data.where('actor.mbox =  /'+event.in+'$/'); 
						for(var i=0; i<data.length; i++){
							data[i].in = Date.parse(data[i].in);
						}
						return data;
					},
			        customize: function (chart) {
			        	var mbox = /[^\/]+$/.exec(globalMbox)[0];
			        	ADL.$('#subChart2 h3').textContent = mbox + " Activities";
			            chart.xAxis.rotateLabels(45);
			            chart.xAxis.tickFormat(function(label){
			                return d3.time.format('%b %d')(new Date(label));
						});	            
			        }
			    });

				
				// draw first graph once it's configured
				actorChart.addChild(objChart);
				actorChart.draw();
			});

		</script>
	</body>
</html>
